# Kafka Producer-Consumer Example

This project demonstrates a simple Kafka-based messaging system with three components:

1. **Producer** - Reads data from a PostgreSQL database and sends changes to Kafka
2. **Consumer** - Reads messages from Kafka and stores them in a separate PostgreSQL database
3. **API** - Provides a simple REST API to query post comments

## Requirements

- Python 3.8+
- Kafka
- PostgreSQL

## Setup

1. Clone the repository
2. Install dependencies:
   ```
   pip install -r requirements.txt
   ```
3. Create a `.env` file based on the `.env.template`:
   ```
   cp .env.template .env
   ```
4. Edit the `.env` file with your specific configuration settings

## Running the Applications

### Producer

```bash
cd producer
python producer.py
```

The producer will:
- Create tables in the PostgreSQL database if they don't exist
- Check for changes in the `post_comments` table every 30 seconds
- Send messages to Kafka for any new, updated, or deleted records

### Consumer

```bash
cd consumer
python consumer.py
```

The consumer will:
- Create tables in a separate PostgreSQL database
- Listen for messages from Kafka
- Store the data in separate `posts` and `comments` tables with proper relationships

### API

```bash
cd api
python api.py
```

The API will:
- Start a FastAPI server on port 8000
- Provide an endpoint at `/posts` that returns all posts with their comments

## API Endpoints

- `GET /posts` - Returns all posts with their comments
- `GET /docs` - Swagger documentation (auto-generated by FastAPI)

## Environment Variables

- `KAFKA_HOST` - Kafka host (e.g., localhost)
- `KAFKA_PORT` - Kafka port (e.g., 9092)
- `KAFKA_TOPIC` - Kafka topic name (e.g., post_comments)
- `PRODUCER_DB_CONNECTION_STRING` - PostgreSQL connection string for the producer
- `CONSUMER_DB_CONNECTION_STRING` - PostgreSQL connection string for the consumer

## Database Schema

### Producer Database

- `post_comments` - Table containing posts and their comments
- `processed_posts` - Table tracking processed posts and their hashes

### Consumer Database

- `posts` - Table containing posts
- `comments` - Table containing comments with foreign keys to posts
